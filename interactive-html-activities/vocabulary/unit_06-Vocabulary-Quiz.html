<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Quiz</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Roboto Slab for clean typography -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Favicon URL - Updated with the new link -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/iconnect-education/activities/refs/heads/main/logos/Aacademiya-favicon.png">
    <!-- Font Awesome for Thumbs Up/Down icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for responsiveness */
        body {
            font-family: 'Roboto Slab', serif;
            background-color: transparent;
        }
        /* Custom styles for button hover effects */
        .primary-button {
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .primary-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -2px rgba(255, 153, 0, 0.4);
        }
        .primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Feedback message animation */
        .feedback-message {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .feedback-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        /* Input focus style for the new theme */
        input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.5);
            border-color: #FF9900;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* This is for the overlay itself */
            display: flex; /* Always display as flex, hidden class will override */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff; /* This should make the content solid white */
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%; /* Ensures responsiveness for smaller screens */
            width: 400px; /* Base width for larger screens */
            transform: translateY(0); /* Removed initial translateY for simplicity */
            transition: none; /* No transition on modal content itself, for immediate display */
            border: 2px solid #FF9900;
        }

        /* Progress Bar Styles */
        .progress-bar-container {
            width: 100%;
            height: 12px; /* Slightly thinner */
            background-color: #e0e0e0; /* Lighter background */
            border-radius: 6px; /* Half of height for rounded caps */
            overflow: hidden; /* Ensure fill stays within bounds */
            margin-bottom: 20px; /* Space below bar */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* Inner shadow for depth */
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #FF9900, #e08000); /* Orange gradient */
            border-radius: 6px;
            transition: width 0.3s ease-out; /* Smooth transition for width changes */
            width: 0%; /* Start at 0% */
        }

        /* Print Specific Styles - These styles will be injected into the new print window */
        @media print {
            body {
                background-color: #fff !important; /* White background for print */
                -webkit-print-color-adjust: exact; /* Ensure background colors are printed */
                color-adjust: exact;
                padding: 0 !important; /* No body padding in print */
                margin: 0 !important;
                display: block !important; /* Override flex for printing */
                height: auto !important;
                min-height: auto !important;
            }
            /* Hide all main content except the print-area */
            .main-content-wrapper,
            .modal-overlay,
            .footer { /* Explicitly hide the main footer in print */
                display: none !important; 
            }
            
            /* Styles for the print-area content itself */
            .print-area-content {
                font-family: 'Roboto Slab', serif;
                color: #333;
                font-size: 11pt; /* Adjusted for A4 readability */
                line-height: 1.2; /* Reduced line-height for a tighter look */
                padding: 20px; /* Padding for the entire printable area */
                border: 1px solid #ddd; /* Subtle border for the printable document */
                box-shadow: 0 0 10px rgba(0,0,0,0.1); /* Slight shadow for a page feel */
                width: calc(100% - 40px); /* Adjust width for padding within 100% */
                box-sizing: border-box; /* Include padding in width */
                margin: 0 auto; /* Center content on print page */
            }
            .print-area-content h2 {
                font-size: 20pt; /* Larger heading for sections */
                font-weight: bold;
                text-align: center;
                margin-top: 25px;
                margin-bottom: 20px;
                color: #FF9900; /* Orange color for print headings */
            }
            .print-area-content .user-info p {
                margin-bottom: 3px;
                font-size: 10pt;
                color: #555;
            }
            .print-area-content .summary {
                margin-top: 20px;
                border-top: 1px dashed #ccc;
                padding-top: 15px;
                margin-bottom: 25px;
            }
            .print-area-content .summary p {
                font-size: 12pt;
                margin-bottom: 8px;
                font-weight: 500;
            }
            .print-area-content .question-item {
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px solid #eee;
            }
            .print-area-content .question-item:last-child {
                border-bottom: none;
            }
            .print-area-content .question-text {
                font-weight: bold;
                margin-bottom: 5px;
                color: #4b5563; /* Darker gray for questions */
            }
            .print-area-content .user-answer, .print-area-content .correct-answer {
                margin-left: 15px;
                font-size: 10pt;
                color: #555;
                line-height: 1.2; /* Ensure these are also tight */
            }
            .print-area-content .user-answer.correct {
                color: #16a34a; /* Tailwind green-600 for correct */
                font-weight: bold;
            }
            .print-area-content .user-answer.incorrect {
                color: #dc2626; /* Tailwind red-600 for incorrect */
                font-weight: bold;
            }
            .print-area-content .correct-answer {
                color: #2563eb; /* Tailwind blue-600 for actual correct answer */
            }

            /* Print Header Content */
            .print-header-content {
                display: flex !important;
                flex-direction: column; /* Stack items vertically */
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #FF9900; /* Stronger orange border */
            }
            .print-header-content .logos-row {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 10px;
            }
            .print-header-content img {
                height: 35px; /* Smaller logos for print header */
                width: auto;
                margin: 0 10px; /* Space between logos */
            }
            .print-header-content h1 {
                font-size: 18pt; /* Print title font size */
                font-weight: bold;
                text-align: center;
                color: #333; /* Darker title for print */
                margin-top: 10px;
            }

            /* Print Footer Content */
            .print-footer-content {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                margin-top: 30px;
                padding-top: 15px;
                border-top: 2px solid #FF9900; /* Stronger orange border */
                text-align: center;
            }
            .print-footer-content .print-teacher-info {
                font-size: 10pt;
                color: #6b7280;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .print-footer-content .print-teacher-info img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: 1px solid #FF9900;
                margin-top: 5px;
                margin-bottom: 5px;
                object-fit: cover;
            }
            .print-footer-content .print-teacher-link {
                color: #FF9900;
                font-weight: bold;
                text-decoration: none;
                font-size: 10pt;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 items-center justify-center"> <!-- Added items-center and justify-center to body -->
    <div class="main-content-wrapper bg-[#E6E6F2] p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-md md:max-w-xl lg:max-w-3xl border border-gray-200 flex-grow"> <!-- Added flex-grow -->

        <!-- Header with logos and title -->
        <div class="flex flex-col items-center mb-6 header-logos">
            <div class="flex justify-between w-full max-w-lg mb-4">
                <!-- Madina Schools Logo - Updated with the new link -->
                <img src="https://raw.githubusercontent.com/iconnect-education/activities/refs/heads/main/logos/Madina-schools-logo.png"
                     class="w-20 md:w-24 lg:w-28 h-auto object-contain" alt="Madina Schools Logo">
                <!-- MYP Programme Logo - Updated with the new link -->
                <img src="https://raw.githubusercontent.com/iconnect-education/activities/refs/heads/main/logos/myp-programme-logo-en-small.png"
                     class="w-28 md:w-32 lg:w-36 h-auto object-contain" alt="MYP Programme Logo">
            </div>
            <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 text-center uppercase">Vocabulary Quiz</h1>
        </div>

        <!-- Start Page -->
        <div id="start-page" class="text-center p-4 sm:p-5 mb-6">
            <p class="text-sm sm:text-base text-gray-600 font-normal mb-6">
                Welcome to the Vocabulary Quiz! <br>
                Your name and email address (if provided) will be used for the printable results page.
            </p>
            <div class="mb-4">
                <label for="userName" class="block text-left text-gray-700 text-sm font-bold mb-2">Name (Optional):</label>
                <input type="text" id="userName" placeholder="Your Name"
                       class="w-full p-2 sm:p-2.5 border border-gray-300 rounded-md text-sm sm:text-base text-gray-700">
                <p id="name-error" class="text-red-500 text-xs mt-1 text-left hidden">Please enter only letters and spaces for your name.</p>
            </div>
            <div class="mb-6">
                <label for="userEmail" class="block text-left text-gray-700 text-sm font-bold mb-2">Email (Optional):</label>
                <input type="email" id="userEmail" placeholder="your.email@example.com"
                       class="w-full p-2 sm:p-2.5 border border-gray-300 rounded-md text-sm sm:text-base text-gray-700">
                <p id="email-error" class="text-red-500 text-xs mt-1 text-left hidden">Please enter a valid email address (e.g., example@domain.com).</p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button id="start-button" class="primary-button bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75 w-full sm:w-auto">
                    Start Activity
                </button>
                <button id="skip-button" class="primary-button bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 w-full sm:w-auto">
                    Skip
                </button>
            </div>
        </div>

        <!-- Quiz Container (hidden by default, shown after start page) -->
        <div id="quiz-container" class="hidden">
            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div id="progressBarFill" class="progress-bar-fill"></div>
            </div>

            <p class="text-center text-base sm:text-lg text-gray-700 mb-6 font-medium">Choose the correct option to complete each statement.</p>

            <div class="sentence-block bg-orange-50 border border-orange-200 rounded-xl p-4 sm:p-5 mb-6 input-section">
                <strong id="question-text" class="text-base sm:text-lg text-gray-800 mb-4 block">...</strong>
                <div id="options-container" class="options mb-3">
                    <!-- Options will be dynamically inserted here -->
                </div>
                <div id="feedback-area" class="text-center mt-4">
                    <p id="feedback-message" class="feedback-message text-sm sm:text-base font-semibold"></p>
                </div>
                <div id="correct-answer-display" class="hidden mt-3 p-3 rounded-md bg-green-100 text-green-800 border border-green-200 text-sm sm:text-base">
                    <strong>Correct Answer:</strong> <span id="actual-answer-text"></span>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 mt-6 quiz-controls">
                <button id="back-button" class="primary-button bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 w-full sm:w-auto" disabled>
                    Back
                </button>
                <button id="check-button" class="primary-button bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75 w-full sm:w-auto">
                    Check Answer
                </button>
                <button id="show-answer-button" class="primary-button bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 w-full sm:w-auto hidden">
                    Show Answer
                </button>
                <button id="next-button" class="primary-button bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75 w-full sm:w-auto hidden">
                    Next Question
                </button>
                <button id="finish-button" class="primary-button bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75 w-full sm:w-auto hidden">
                    Finish Activity
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Modal (Moved outside main-content-wrapper) -->
    <div id="performance-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Activity Complete!</h2>
            <p class="text-lg text-gray-700 mb-2">You scored: <span id="score-display" class="font-bold text-orange-600"></span></p>
            <p class="text-lg text-gray-700 mb-6">That's <span id="percentage-display" class="font-bold text-orange-600"></span>! <span id="feedback-message-modal" class="font-bold"></span></p>
            <i id="feedback-icon" class="ml-2 text-6xl my-4"></i> <!-- Increased size and added margin -->
            <p class="text-sm text-gray-600 mt-2">Completed by: <span id="modal-user-name"></span> on <span id="modal-date-time"></span></p>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 mt-6">
                <button id="restart-modal-button" class="primary-button bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75 w-full sm:w-auto">
                    Restart Activity
                </button>
                <button id="print-activity-button" class="primary-button bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 w-full sm:w-auto">
                    Print Results
                </button>
            </div>
        </div>
    </div>

    <!-- Printable Area - This div is no longer directly used for printing on the main page -->
    <div class="print-area hidden"></div>

    <!-- Footer -->
    <div class="footer text-center mt-8 text-gray-600 text-sm flex flex-col items-center">
        <p class="mb-1">Activity prepared by</p>
        <p class="font-bold text-gray-800 mb-1.5">Teacher Abderrahman BOUJAADA</p>
        <!-- Teacher's Avatar - Updated with the new link -->
        <img src="https://raw.githubusercontent.com/iconnect-education/activities/refs/heads/main/logos/My_Portrait.png" alt="Teacher's Avatar" class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-orange-400 shadow-md">
        <a href="https://academiya.co.uk/" class="text-orange-600 hover:underline">https://academiya.co.uk/</a>
    </div>

    <script>
        // Quiz Data: All exercises combined into one array of questions
        const questions = [
            // Exercise 1: Matching (adapted to multiple choice)
            {
                question: "Which of the following best describes a 'prequel'?",
                options: ["A movie about events that follow the original one.", "A movie about events that happen before the original one.", "A specific type or category of films.", "A magazine produced by fans."],
                answer: "A movie about events that happen before the original one."
            },
            {
                question: "What is a 'fanzine'?",
                options: ["A group of people who are fans of something.", "A small, informal magazine for fans of a particular thing.", "Souvenirs or collected items related to an event.", "A person who is very enthusiastic about something."],
                answer: "A small, informal magazine for fans of a particular thing."
            },
            {
                question: "What does 'genre' refer to?",
                options: ["The official follow-up to a story or film.", "A specific type or category, especially of art, music, or literature.", "A collection of items related to a famous person.", "The dedicated followers of a celebrity or show."],
                answer: "A specific type or category, especially of art, music, or literature."
            },
            {
                question: "Which option defines a 'sequel'?",
                options: ["A film or book that comes before the original.", "A spin-off project from a popular series.", "A literary or cinematic work that continues the story of an earlier work.", "Items collected by fans."],
                answer: "A literary or cinematic work that continues the earlier work."
            },
            {
                question: "What is 'memorabilia'?",
                options: ["A type of magazine for fans.", "A group of fans.", "Objects kept or collected because of their historical interest, especially those associated with famous people or events.", "Goods sold to promote an event or show."],
                answer: "Objects kept or collected because of their historical interest, especially those associated with famous people or events."
            },
            {
                question: "What is 'fandom'?",
                options: ["A single fan of something.", "The state of being very excited about something.", "The fans of a particular person, team, series, etc., regarded collectively as a community or subculture.", "A product created from a popular series."],
                answer: "The fans of a particular person, team, series, etc., regarded collectively as a community or subculture."
            },

            // Exercise 2: Complete the definitions (adapted to multiple choice)
            {
                question: "An ________ is someone that is loved or admired a lot.",
                options: ["enthusiast", "fan base", "idol", "merchandise", "spinoff"],
                answer: "idol"
            },
            {
                question: "A ________ is something that is produced due to the popularity of something else.",
                options: ["enthusiast", "fan base", "idol", "merchandise", "spinoff"],
                answer: "spinoff"
            },
            {
                question: "An ________ is someone that likes or enjoys something very much.",
                options: ["enthusiast", "fan base", "idol", "merchandise", "spinoff"],
                answer: "enthusiast"
            },
            {
                question: "A ________ is the number of people that are fans of a particular thing.",
                options: ["enthusiast", "fan base", "idol", "merchandise", "spinoff"],
                answer: "fan base"
            },
            {
                question: "________ is something that you can buy that is connected with an event.",
                options: ["enthusiast", "fan base", "idol", "merchandise", "spinoff"],
                answer: "merchandise"
            },

            // Exercise 3: Choose the correct option
            {
                question: "Having been translated into many different languages, *The Lord of the Rings* has a global ________.",
                options: ["prequel", "fan base", "spinoff"],
                answer: "fan base"
            },
            {
                question: "The ________ to her first novel is eagerly anticipated.",
                options: ["genre", "fandom", "sequel"],
                answer: "sequel"
            },
            {
                question: "She must be a real ________ - she regularly takes part in live action role-playing games.",
                options: ["spinoff", "fanzine", "enthusiast"],
                answer: "enthusiast"
            },
            {
                question: "His home is like a museum. It's full of original movie ________.",
                options: ["memorabilia", "genre", "fandom"],
                answer: "memorabilia"
            },
            {
                question: "Mom loves that singer. He's been her ________ since she was a teenager.",
                options: ["merchandise", "idol", "fanzine"],
                answer: "idol"
            },
            {
                question: "Zombie films aren't my favorite ________ of movies.",
                options: ["genre", "prequel", "sequel"],
                answer: "genre"
            },

            // Exercise 4: Dialogue fill-in-the-blank
            {
                question: "Claudia: I'm delighted to have Ted Armstrong with me on the program today. Ted, you've been a successful (1) ________ for a decade now, but tell me, did you use to write plays when you were a child?",
                options: ["copyright", "installment", "playwright", "storyline", "subscription"],
                answer: "playwright"
            },
            {
                question: "Ted: No, I didn't actually, but I did use to write short stories. One of the stories, *Across the Ocean*, was pretty popular and people couldn't wait to read the next (2) ________.",
                options: ["copyright", "installment", "playwright", "storyline", "subscription"],
                answer: "installment"
            },
            {
                question: "Claudia: Sounds like you could have charged a (3) ________ for it!",
                options: ["copyright", "installment", "playwright", "storyline", "subscription"],
                answer: "subscription"
            },
            {
                question: "Claudia: What was the (4) ________? Did you base it on one of your favorite novels?",
                options: ["copyright", "installment", "playwright", "storyline", "subscription"],
                answer: "storyline"
            },
            {
                question: "Ted: No, it was all original material. I didn't want any issues with (5) ________ if it was going to be published!",
                options: ["copyright", "installment", "playwright", "storyline", "subscription"],
                answer: "copyright"
            }
        ];

        // Global variables for quiz state
        let currentQuestionIndex = 0;
        let correctAnswersCount = 0;
        let userAnswers = []; // To store user's answer and correct answer for printing

        // Define a structured question object to keep track of answered state more clearly
        // This will be populated as questions are answered
        let quizState = questions.map(q => ({
            question: q.question,
            options: q.options,
            answer: q.answer,
            userAttempt: null, // Stores the user's selected option for this question
            isCorrect: null,   // True/False/Null
            answered: false    // True if check or show answer has been clicked
        }));

        let userName = '';
        let userEmail = '';

        // DOM Element references
        const startPage = document.getElementById('start-page');
        const quizContainer = document.getElementById('quiz-container');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackArea = document.getElementById('feedback-area');
        const correctAnswerDisplay = document.getElementById('correct-answer-display');
        const actualAnswerText = document.getElementById('actual-answer-text');
        const backButton = document.getElementById('back-button'); // New back button reference
        const checkButton = document.getElementById('check-button');
        const showAnswerButton = document.getElementById('show-answer-button');
        const nextButton = document.getElementById('next-button');
        const finishButton = document.getElementById('finish-button');
        const performanceModal = document.getElementById('performance-modal');
        const scoreDisplay = document.getElementById('score-display');
        const percentageDisplay = document.getElementById('percentage-display');
        const restartModalButton = document.getElementById('restart-modal-button');
        const printActivityButton = document.getElementById('print-activity-button');
        const userNameInput = document.getElementById('userName');
        const userEmailInput = document.getElementById('userEmail');
        const startButton = document.getElementById('start-button');
        const skipButton = document.getElementById('skip-button');
        const nameError = document.getElementById('name-error');
        const emailError = document.getElementById('email-error');
        const progressBarFill = document.getElementById('progressBarFill');

        // References for modal details
        const modalUserName = document.getElementById('modal-user-name');
        const modalDateTime = document.getElementById('modal-date-time');
        const feedbackMessageModal = document.getElementById('feedback-message-modal');
        const feedbackIcon = document.getElementById('feedback-icon');


        /**
         * Validates the user's name input.
         * Only allows letters and spaces.
         * @returns {boolean} True if the name is valid, false otherwise.
         */
        function validateName(name) {
            return /^[a-zA-Z\s]*$/.test(name);
        }

        /**
         * Validates the user's email input using a simple regex.
         * @returns {boolean} True if the email is valid, false otherwise.
         */
        function validateEmail(email) {
            // Simple email regex, can be enhanced for more strict validation
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) || email === ''; // Email is optional
        }

        /**
         * Returns a performance feedback string based on the given percentage.
         * @param {number} percentage The user's score percentage.
         * @returns {string} The feedback message.
         */
        function getPerformanceFeedback(percentage) {
            if (percentage >= 90) {
                return "Excellent!";
            } else if (percentage >= 75) {
                return "Very Good!";
            } else if (percentage >= 50) {
                return "Average.";
            } else {
                return "Below Average.";
            }
        }

        /**
         * Loads the current question and its options into the quiz interface.
         * Handles both forward and backward navigation.
         */
        function loadQuestion() {
            const currentQuestionState = quizState[currentQuestionIndex];
            const originalQuestion = questions[currentQuestionIndex];

            // Reset feedback area and answer display
            feedbackArea.classList.remove('show');
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('text-green-600', 'text-red-600', 'text-orange-600');
            correctAnswerDisplay.classList.add('hidden');

            questionTextElement.textContent = originalQuestion.question;
            optionsContainer.innerHTML = ''; // Clear previous options

            // Shuffle options for new questions, but keep original order for revisited questions
            const optionsToDisplay = currentQuestionState.answered ?
                                     originalQuestion.options : // Use original order to easily find selected/correct
                                     [...originalQuestion.options].sort(() => Math.random() - 0.5);


            optionsToDisplay.forEach(option => {
                const label = document.createElement('label');
                label.className = 'block mb-2 p-3 bg-white rounded-md cursor-pointer hover:bg-gray-100 transition duration-200 ease-in-out border border-gray-300';
                label.innerHTML = `
                    <input type="radio" name="answer" value="${option}" class="mr-3 accent-orange-600">
                    ${option}
                `;
                optionsContainer.appendChild(label);
            });

            // Set button states and display based on whether the question has been answered
            if (currentQuestionState.answered) {
                // Restore selection and feedback for answered questions
                optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.disabled = true; // Disable if already answered
                    if (radio.value === currentQuestionState.userAttempt) {
                        radio.checked = true;
                        if (currentQuestionState.isCorrect) {
                            radio.parentElement.classList.add('bg-green-100', 'border-green-400');
                            feedbackMessage.textContent = 'Correct! Well done!';
                            feedbackMessage.classList.add('text-green-600', 'show');
                        } else if (currentQuestionState.userAttempt === "Answer Revealed") {
                             radio.parentElement.classList.add('bg-green-100', 'border-green-400'); // Highlight correct even if revealed
                             actualAnswerText.textContent = originalQuestion.answer;
                             correctAnswerDisplay.classList.remove('hidden');
                             feedbackMessage.textContent = 'The correct answer is displayed above.';
                             feedbackMessage.classList.add('text-orange-600', 'show');
                        } else {
                            radio.parentElement.classList.add('bg-red-100', 'border-red-400');
                            feedbackMessage.textContent = 'Incorrect.';
                            feedbackMessage.classList.add('text-red-600', 'show');
                            actualAnswerText.textContent = originalQuestion.answer;
                            correctAnswerDisplay.classList.remove('hidden'); // Show correct answer for incorrect attempts
                        }
                    }
                });
                checkButton.classList.add('hidden');
                showAnswerButton.classList.add('hidden');

                // If already answered, show next/finish if applicable
                if (currentQuestionIndex < questions.length - 1) {
                    nextButton.classList.remove('hidden');
                    finishButton.classList.add('hidden');
                } else {
                    nextButton.classList.add('hidden');
                    finishButton.classList.remove('hidden');
                }

            } else {
                // For a new, unanswered question
                optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.disabled = false;
                    radio.parentElement.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400');
                });
                checkButton.classList.remove('hidden');
                showAnswerButton.classList.add('hidden');
                nextButton.classList.add('hidden');
                finishButton.classList.add('hidden');
            }
            
            // Back button logic
            if (currentQuestionIndex > 0) {
                backButton.disabled = false;
            } else {
                backButton.disabled = true;
            }

            updateProgressBar();
        }


        /**
         * Checks the user's selected answer against the correct answer.
         * Provides visual feedback and updates buttons.
         */
        function checkAnswer() {
            const selectedOption = document.querySelector('input[name="answer"]:checked');
            const userAnswer = selectedOption ? selectedOption.value : null;
            const currentQuestionState = quizState[currentQuestionIndex];
            const originalQuestion = questions[currentQuestionIndex];

            // Clear previous highlighting from all options before applying new one
            optionsContainer.querySelectorAll('label').forEach(label => {
                label.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400');
            });

            if (!userAnswer) {
                feedbackMessage.textContent = 'Please select an answer.';
                feedbackMessage.classList.remove('text-green-600', 'text-red-600');
                feedbackMessage.classList.add('text-orange-600', 'show');
                return; // Stop if no answer is selected
            }

            // Update quizState for the current question
            currentQuestionState.userAttempt = userAnswer;
            currentQuestionState.answered = true;

            if (userAnswer === originalQuestion.answer) {
                if (!currentQuestionState.isCorrect) { // Only increment if it's a new correct answer
                    correctAnswersCount++;
                    currentQuestionState.isCorrect = true;
                }
                
                feedbackMessage.textContent = 'Correct! Well done!';
                feedbackMessage.classList.remove('text-red-600', 'text-orange-600');
                feedbackMessage.classList.add('text-green-600', 'show');
                selectedOption.parentElement.classList.add('bg-green-100', 'border-green-400');

                // Disable all radio buttons
                optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.disabled = true;
                });

                checkButton.classList.add('hidden');
                showAnswerButton.classList.add('hidden');
                if (currentQuestionIndex < questions.length - 1) {
                    nextButton.classList.remove('hidden');
                    finishButton.classList.add('hidden');
                } else {
                    nextButton.classList.add('hidden');
                    finishButton.classList.remove('hidden');
                }
                correctAnswerDisplay.classList.add('hidden');

            } else { // Incorrect answer
                currentQuestionState.isCorrect = false; // Mark as incorrect
                feedbackMessage.textContent = 'Incorrect. Try again!';
                feedbackMessage.classList.remove('text-green-600', 'text-orange-600');
                feedbackMessage.classList.add('text-red-600', 'show');
                selectedOption.parentElement.classList.add('bg-red-100', 'border-red-400');

                // Keep radio buttons enabled for another attempt
                optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.disabled = false;
                });
                // Re-select the option after clearing others to maintain user's choice visual
                selectedOption.checked = true;

                checkButton.classList.remove('hidden');
                checkButton.disabled = false;
                showAnswerButton.classList.remove('hidden');
                nextButton.classList.add('hidden'); // Hide next button until answered correctly or shown
                finishButton.classList.add('hidden');
                correctAnswerDisplay.classList.add('hidden');
            }
        }

        /**
         * Displays the correct answer if the user needs a hint.
         */
        function showAnswer() {
            const currentQuestionState = quizState[currentQuestionIndex];
            const originalQuestion = questions[currentQuestionIndex];

            actualAnswerText.textContent = originalQuestion.answer;
            correctAnswerDisplay.classList.remove('hidden');
            feedbackMessage.textContent = 'The correct answer is displayed above.';
            feedbackMessage.classList.remove('text-green-600', 'text-red-600');
            feedbackMessage.classList.add('text-orange-600', 'show'); // Use orange for hints

            // Update quizState for the current question
            currentQuestionState.userAttempt = "Answer Revealed"; // Indicate user revealed answer
            currentQuestionState.isCorrect = false; // Mark as incorrect since they didn't figure it out
            currentQuestionState.answered = true; // Mark as answered

            // Disable all radio buttons and highlight the correct one
            optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
                radio.parentElement.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400');
                if (radio.value === originalQuestion.answer) {
                    radio.parentElement.classList.add('bg-green-100', 'border-green-400');
                    radio.checked = true; // Select the correct one
                } else {
                    radio.checked = false; // Deselect other options
                }
            });

            checkButton.classList.add('hidden');
            showAnswerButton.classList.add('hidden');
            if (currentQuestionIndex < questions.length - 1) {
                nextButton.classList.remove('hidden');
                finishButton.classList.add('hidden');
            } else {
                finishButton.classList.remove('hidden');
                nextButton.classList.add('hidden'); // Ensure next is hidden on last question
            }
        }

        /**
         * Moves to the next question or finishes the activity if all questions are answered.
         */
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                loadQuestion();
            } else {
                showPerformanceModal();
            }
        }

        /**
         * Moves to the previous question.
         */
        function backQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        /**
         * Updates the progress bar based on the current question index.
         */
        function updateProgressBar() {
            const progress = (currentQuestionIndex / questions.length) * 100;
            progressBarFill.style.width = `${progress}%`;
        }

        /**
         * Displays the performance modal with the user's score.
         */
        function showPerformanceModal() {
            // Recalculate correct answers based on quizState, as userAnswers can be "Answer Revealed"
            correctAnswersCount = quizState.filter(q => q.isCorrect === true).length;

            const totalQuestions = questions.length;
            const percentage = (correctAnswersCount / totalQuestions) * 100;
            const feedbackText = getPerformanceFeedback(percentage);

            scoreDisplay.textContent = `${correctAnswersCount} / ${totalQuestions}`;
            percentageDisplay.textContent = `${percentage.toFixed(0)}%`;
            feedbackMessageModal.textContent = `(${feedbackText})`; // Display feedback in modal

            // Update feedback icon
            feedbackIcon.classList.remove('fa-thumbs-up', 'fa-thumbs-down', 'text-green-600', 'text-red-600');
            if (percentage >= 75) { // Assuming 75% or higher is "good" for thumbs up
                feedbackIcon.classList.add('fa-solid', 'fa-thumbs-up', 'text-green-600');
            } else {
                feedbackIcon.classList.add('fa-solid', 'fa-thumbs-down', 'text-red-600');
            }


            // Get and display current date and time in the modal
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const formattedDate = now.toLocaleDateString('en-US', dateOptions);
            const formattedTime = now.toLocaleTimeString('en-US', timeOptions);
            modalDateTime.textContent = `${formattedDate} ${formattedTime}`;
            modalUserName.textContent = userName || 'Guest'; // Display user name or 'Guest'

            performanceModal.classList.remove('hidden'); // Ensure the modal is no longer display: none
            quizContainer.classList.add('hidden');
        }

        /**
         * Restarts the activity, resetting all state variables.
         */
        function restartActivity() {
            currentQuestionIndex = 0;
            correctAnswersCount = 0;
            // Reset quizState for a fresh start
            quizState = questions.map(q => ({
                question: q.question,
                options: q.options,
                answer: q.answer,
                userAttempt: null,
                isCorrect: null,
                answered: false
            }));
            
            userName = '';
            userEmail = '';
            userNameInput.value = '';
            userEmailInput.value = '';

            performanceModal.classList.add('hidden'); // Hide the modal completely
            startPage.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            updateProgressBar(); // Reset progress bar
        }

        /**
         * Generates the HTML content for printing and opens a print dialog.
         */
        function printResults() {
            // Recalculate correct answers based on quizState for the printout
            const correctCountForPrint = quizState.filter(q => q.isCorrect === true).length;
            const totalQuestions = questions.length;
            const percentage = (correctCountForPrint / totalQuestions) * 100;
            const feedbackText = getPerformanceFeedback(percentage);

            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const formattedDate = now.toLocaleDateString('en-US', dateOptions);
            const formattedTime = now.toLocaleTimeString('en-US', timeOptions);

            let printContent = `
                <div class="print-header-content">
                    <div class="logos-row">
                        <img src="https://raw.githubusercontent.com/iconnect-education/activities/refs/heads/main/logos/Madina-schools-logo.png" alt="Madina Schools Logo">
                        <img src="https://raw.githubusercontent.com/iconnect-education/activities/refs/heads/main/logos/myp-programme-logo-en-small.png" alt="MYP Programme Logo">
                    </div>
                    <h1>Vocabulary Quiz Results</h1>
                </div>
                <div class="user-info">
                    ${userName ? `<p><strong>Name:</strong> ${userName}</p>` : ''}
                    ${userEmail ? `<p><strong>Email:</strong> ${userEmail}</p>` : ''}
                    <p><strong>Date:</strong> ${formattedDate}</p>
                    <p><strong>Time:</strong> ${formattedTime}</p>
                </div>
                <div class="summary">
                    <p><strong>Overall Score:</strong> ${correctCountForPrint} out of ${questions.length} (${percentage.toFixed(0)}%)</p>
                    <p><strong>Performance:</strong> ${feedbackText}</p>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px dashed #FF9900;">
            `;

            quizState.forEach((item, index) => {
                const questionNumber = index + 1;
                let userAnswerDisplay = item.userAttempt || '[No answer provided]';
                let userAnswerClass = '';

                if (item.answered) {
                    if (item.isCorrect) {
                        userAnswerClass = 'correct';
                    } else if (item.userAttempt === "Answer Revealed") {
                        userAnswerClass = 'incorrect'; // Still count as incorrect for scoring
                        userAnswerDisplay = 'Answer Revealed'; // Display specifically
                    } else {
                        userAnswerClass = 'incorrect';
                    }
                } else {
                    userAnswerDisplay = '[Not Attempted]'; // If question wasn't even visited
                }

                const originalQuestionText = questions[index].question.replace(/<\/?strong>/g, ''); // Get original question text without strong tags
                
                printContent += `
                    <div class="question-item">
                        <p class="question-text">${questionNumber}. ${originalQuestionText}</p>
                        <p class="user-answer ${userAnswerClass}">Your Answer: ${userAnswerDisplay}</p>
                        ${!item.isCorrect && item.answered ? `<p class="correct-answer">Correct Answer: ${questions[index].answer}</p>` : ''}
                    </div>
                `;
            });

            printContent += `
                <div class="print-footer-content">
                    <div class="print-teacher-info">
                        <p>Activity prepared by</p>
                        <p class="font-bold">Teacher Abderrahman BOUJAADA</p>
                        <img src="https://raw.githubusercontent.com/iconnect-education/activities/refs/heads/main/logos/My_Portrait.png" alt="Teacher's Avatar">
                        <a href="https://academiya.co.uk/" target="_blank" class="print-website-link">https://academiya.co.uk/</a>
                    </div>
                </div>
            `;

            // Create a new window for printing and inject content and styles
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                // Using console.error instead of alert as per general instructions
                console.error('Pop-ups blocked. Please allow pop-ups for printing.');
                return;
            }

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Vocabulary Quiz Results</title>
                    <style>
                        body {
                            font-family: 'Roboto Slab', serif;
                            background-color: #fff;
                            margin: 0;
                            padding: 0;
                            -webkit-print-color-adjust: exact;
                            color-adjust: exact;
                        }
                        @page {
                            size: A4;
                            margin: 1cm;
                        }
                        /* Styles for the print-area-content itself */
                        .print-area-content {
                            padding: 20px; /* Consistent side padding for print content */
                            border: 1px solid #ddd;
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                            width: calc(100% - 40px); /* Adjust width for padding within 100% */
                            box-sizing: border-box;
                            margin: 0 auto;
                            line-height: 1.2; /* Reduced line-height for a tighter look */
                        }
                        .print-area-content h2 {
                            font-size: 20pt;
                            font-weight: bold;
                            text-align: center;
                            margin-top: 25px;
                            margin-bottom: 20px;
                            color: #FF9900;
                        }
                        .print-area-content .user-info p {
                            margin-bottom: 3px;
                            font-size: 10pt;
                            color: #555;
                        }
                        .print-area-content .summary {
                            margin-top: 20px;
                            border-top: 1px dashed #ccc;
                            padding-top: 15px;
                            margin-bottom: 25px;
                        }
                        .print-area-content .summary p {
                            font-size: 12pt;
                            margin-bottom: 8px;
                            font-weight: 500;
                        }
                        .print-area-content .question-item {
                            margin-bottom: 12px;
                            padding-bottom: 12px;
                            border-bottom: 1px solid #eee;
                        }
                        .print-area-content .question-item:last-child {
                            border-bottom: none;
                        }
                        .print-area-content .question-text {
                            font-weight: bold;
                            margin-bottom: 5px;
                            color: #4b5563;
                        }
                        .print-area-content .user-answer, .print-area-content .correct-answer {
                            margin-left: 15px;
                            font-size: 10pt;
                            color: #555;
                            line-height: 1.2; /* Ensure these are also tight */
                        }
                        .print-area-content .user-answer.correct {
                            color: #16a34a;
                            font-weight: bold;
                        }
                        .print-area-content .user-answer.incorrect {
                            color: #dc2626;
                            font-weight: bold;
                        }
                        .print-area-content .correct-answer {
                            color: #2563eb;
                        }
                        .print-header-content {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            margin-bottom: 20px;
                            padding-bottom: 15px;
                            border-bottom: 2px solid #FF9900;
                        }
                        .print-header-content .logos-row {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            margin-bottom: 10px;
                        }
                        .print-header-content img {
                            height: 35px;
                            width: auto;
                            margin: 0 10px;
                        }
                        .print-header-content h1 {
                            font-size: 18pt;
                            font-weight: bold;
                            text-align: center;
                            color: #333;
                            margin-top: 10px;
                        }
                        .print-footer-content {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 2px solid #FF9900;
                            text-align: center;
                        }
                        .print-footer-content .print-teacher-info {
                            font-size: 10pt;
                            color: #6b7280;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                        }
                        .print-footer-content .print-teacher-info img {
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            border: 1px solid #FF9900;
                            margin-top: 5px;
                            margin-bottom: 5px;
                            object-fit: cover;
                        }
                        .print-footer-content .print-teacher-link {
                            color: #FF9900;
                            font-weight: bold;
                            text-decoration: none;
                            font-size: 10pt;
                            margin-top: 5px;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-area-content">
                        ${printContent}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close(); // Close the document opened with document.write
            printWindow.focus(); // Focus on the new window
            printWindow.print(); // Print the new window
            // printWindow.close(); // Keep window open for inspection if needed during debugging
        }


        // Event Listeners - Moved inside DOMContentLoaded for robustness
        document.addEventListener('DOMContentLoaded', () => {
            startPage.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            updateProgressBar(); // Initialize progress bar to 0%

            startButton.addEventListener('click', () => {
                const nameIsValid = validateName(userNameInput.value);
                const emailIsValid = validateEmail(userEmailInput.value);

                nameError.classList.toggle('hidden', nameIsValid);
                emailError.classList.toggle('hidden', emailIsValid);

                if (nameIsValid && emailIsValid) {
                    userName = userNameInput.value.trim();
                    userEmail = userEmailInput.value.trim();
                    startPage.classList.add('hidden');
                    quizContainer.classList.remove('hidden');
                    loadQuestion();
                }
            });

            skipButton.addEventListener('click', () => {
                userName = ''; // Ensure name and email are empty if skipped
                userEmail = '';
                // Hide any lingering error messages if the user decided to skip after typing invalid input
                nameError.classList.add('hidden');
                emailError.classList.add('hidden');
                startPage.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                loadQuestion();
            });

            backButton.addEventListener('click', backQuestion); // Add event listener for back button
            checkButton.addEventListener('click', checkAnswer);
            showAnswerButton.addEventListener('click', showAnswer);
            nextButton.addEventListener('click', nextQuestion);
            finishButton.addEventListener('click', showPerformanceModal);
            restartModalButton.addEventListener('click', restartActivity);
            printActivityButton.addEventListener('click', printResults);
        });
    </script>
</body>
</html>
